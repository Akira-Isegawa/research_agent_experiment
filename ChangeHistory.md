# IdeaAgent Experiment — Development History

このファイルは本リポジトリで行った主要な実験と修正の履歴を、対話履歴にもとづいて要約したものです。Qiita用のレポート草案としても使えるよう、経緯・原因分析・対応・今後の方針を簡潔にまとめています。

## 概要（ハイレベル）
- プロジェクト: IdeaAgentExperiment（エージェントによる自動リサーチ実験）
- 目的: LLM + ツール（Web検索等）を組み合わせ、反復的に調査・検証・評価するワークフローを構築

## 主な時系列イベント
1. 初期実装: SimpleSearch（ワンショット検索） → AgenticSearch（計画→調査→評価の反復）→ Comparison の3フェーズを実装
2. 仕様改善: スキーマのデフォルト値修正（安定化）と JSON 切断問題に対するリトライ対応を導入（過去コミット: `e98b447`, `6580cf6`）
3. フィードバックループ追加: ファクトチェッカー（FC）→リサーチャー／評価者へ結果を渡すループを導入（コミット: `c30cb2b`）

## 問題発見（重大インシデント）
- 出力例: `agentic_search_20260210_232456.md` において、反復2〜5の発見・URLがほぼすべて**架空の（ハルシネーション）URL**に置き換わっていた。
- 原因要約:
  - ファクトチェッカーのプロンプトに「代替URLを探して差し替える」という指示があり、FC 自身が新しい（しかし根拠の薄い）URLを生成してしまった。
  - さらに処理系で FC の出力がそのまま `current_result` に上書きされ、リサーチャーの生出力（元のURL）が失われていた。
  - FC が失敗（`verified:0 removed:0` など）した反復のデータも最終レポートに含まれてしまっていた。

## 根本原因分析
1. FC が「検証＋代替URL生成」を行っていた → LLM による代替URL捏造を誘発
2. ワークフロー実装が FC 出力をデータソースとして直接置換していた → リサーチャーの元データを破壊
3. FC失敗時の扱いが曖昧で、失敗データがスコアリング・レポートに反映されていた

## 実施した対策（今回の修正）
1. ファクトチェッカーの役割を「合格/不合格（pass/fail）フィルタ」に限定
   - `fact_checker.py` の指示から代替URL探索／差し替えロジックを完全削除
   - 出力は verified（合格） / fabricated（不合格）の2値に簡素化
2. リサーチャーの生出力を保存
   - 各反復の `findings` / `evidence` を変更せずに `raw_results` として保存（JSON 別ファイル: `raw_research_{timestamp}.json`）
3. FC の検証結果は**元のリサーチャーデータ**を参照して照合するのみ
   - FC が「verified」とした項目は元データとマッチングして `accepted_findings` / `accepted_evidence` に追加
   - FC が不合格としたデータは最終報告に一切含めない（スコア的には実質ゼロ扱い）
4. 戻り値・レポート出力の修正
   - `run_agentic_research` の戻り値を 4-tuple → 5-tuple に変更（末尾に `raw_results` を追加）
   - `main.py` 側で 5-tuple を受け取り、`raw_results` を JSON に保存し、Markdown レポートに付録として生データを出力

## 変更ファイル（主要）
- `workflows/research.py` — FC処理ロジックの改修／raw_results 保存／返り値変更
- `agent_definitions/fact_checker.py` — URL差し替え指示の削除（verified/fabricated の2値へ）
- `main.py` — 5-tuple対応、raw_results の保存、レポート付録の追加
- `tests/test_feedback_loop.py` — 5-tupleとraw_results対応のユニットテストを追加・修正

## テスト結果
- 変更後、ローカルで `pytest` を実行し、全93件のテストが成功しました（所要時間: 約1.0s）。

## 今後の推奨ステップ（Qiita記事向けの章立て案）
1. 問題の再現: 問題発生時の出力サンプルとログを提示（`agentic_search_20260210_232456.md` を参照）
2. 原因解析: LLM による「代替URL生成」を引き起こした設計上の弱点を説明
3. 対策実装: 今回の修正（FCの役割明確化 + raw 保存 + レポート除外）をコード抜粋で示す
4. 検証: テスト結果と手動確認、期待される出力サンプル
5. 学びとベストプラクティス: ツール連携時の設計注意点（検証は必ず原データ参照、LLMに生成させない）

## 追加メモ（短期的な改善候補）
- FactChecker に外部 HTTP 実行（実際の HEAD/GET）を組み合わせた二次検証を入れる
- 信頼性メトリクスを詳細化（ソース種別ごとの信頼度重み付け）
- 出力監査ログを自動で差分比較する仕組みを追加

---
_最終更新: 2026-02-11_
